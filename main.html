<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura: God's Window</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --gold-primary: #ffb38a;
            --gold-glow: #e66a45;
            --text-main: #e0dcd9;
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-warm: rgba(20, 20, 20, 0.6);

            --font-display: 'Cormorant Garamond', serif;
            --font-ui: 'Inter', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #111;
            font-family: var(--font-ui);
            color: var(--text-main);
        }

        /* --- PHONE MOCKUP --- */
        .phone-frame {
            width: 390px;
            /* iPhone 14/15 Pro width */
            height: 844px;
            background: #000;
            border-radius: 50px;
            box-shadow: 0 0 0 12px #2c2c2c, 0 0 0 14px #1a1a1a, 0 20px 50px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Dynamic Island / Notch */
        .dynamic-island {
            width: 120px;
            height: 35px;
            background: #000;
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 20px;
            z-index: 100;
            pointer-events: none;
        }

        /* --- THE MAP (BACKGROUND) --- */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #000;
        }

        /* Customizing Leaflet controls to look cleaner */
        .leaflet-control-attribution {
            font-size: 8px !important;
            background: rgba(0, 0, 0, 0.5) !important;
            color: #aaa !important;
        }

        .leaflet-control-attribution a {
            color: #aaa !important;
        }

        /* --- ATMOSPHERE LAYERS REMOVED --- */

        .vignette {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            z-index: 4;
            pointer-events: none;
        }

        /* --- THE UI LAYER --- */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            /* Let clicks pass through to map */
        }

        /* 1. THE MEMORY (IMAGE SECTION) */
        .memory-card {
            position: absolute;
            top: 140px;
            /* Moved down */
            left: 40px;
            width: 160px;
            height: 200px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: var(--glass-warm);
            backdrop-filter: blur(12px) brightness(1.1);
            -webkit-backdrop-filter: blur(12px) brightness(1.1);
            z-index: 20;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            pointer-events: auto;
        }

        .memory-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.9;
        }

        /* 2. THE BEACON (PIN) */
        .map-pin {
            width: 80px;
            height: 80px;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            position: relative;
        }

        .pin-icon {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 0 15px var(--gold-primary));
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            /* Hidden in Overview */
            transform: scale(0.5);
        }

        .glow-point-main {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--gold-primary);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--gold-primary), 0 0 30px var(--gold-glow);
            transition: all 0.5s ease;
            opacity: 1;
            /* Visible in Overview */
            transform: scale(1);
            animation: light-pulse 2s infinite alternate;
            z-index: 1;
        }

        /* Detail Mode: Show Image, Hide Glow */
        body.detail-mode .pin-icon {
            opacity: 1;
            transform: scale(1);
            animation: pulse 3s infinite ease-in-out;
        }

        body.detail-mode .glow-point-main {
            opacity: 0;
            transform: scale(0.5);
            animation: none;
        }

        /* --- LIGHTHOUSE MODE BEACONS --- */
        .lighthouse-pin {
            position: relative;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* The Building Image (Visible ONLY in Detail Mode) */
        .lighthouse-pin .building-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }

        /* The Glow Point (Visible ONLY in Overview Mode) */
        .lighthouse-pin .glow-point {
            width: 12px;
            height: 12px;
            background: var(--gold-primary);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--gold-primary), 0 0 20px var(--gold-glow);
            opacity: 0;
            /* Hidden by default, toggled by .active */
            transition: opacity 0.3s;
        }

        /* Overview Mode: Cycle the Glows */
        .lighthouse-pin.active .glow-point {
            opacity: 1;
            animation: light-pulse 1s infinite alternate;
        }

        @keyframes light-pulse {
            from {
                transform: scale(1);
                opacity: 0.6;
                box-shadow: 0 0 10px var(--neon-green);
            }

            to {
                transform: scale(1.5);
                opacity: 1;
                box-shadow: 0 0 25px var(--gold-primary), 0 0 40px var(--gold-glow);
            }
        }

        /* Detail Mode: Show Buildings, Hide Glows */
        .detail-mode .lighthouse-pin .building-img {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .detail-mode .lighthouse-pin .glow-point {
            display: none;
        }

        /* --- STICKER COMPONENT --- */
        .memory-sticker {
            position: absolute;
            top: -50px;
            /* Positioned ABOVE the card */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 30;
            white-space: nowrap;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.4));
        }

        .sticker-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #fff;
            background-color: #333;
            background-size: cover;
            /* Overlap name tag slightly */
            z-index: 2;
            /* Soul Glow - Narrative: He is "alive" in this memory */
            box-shadow: 0 0 10px rgba(255, 179, 138, 0.4);
            animation: soul-breathe 4s ease-in-out infinite;
        }

        @keyframes soul-breathe {

            0%,
            100% {
                box-shadow: 0 0 8px rgba(255, 179, 138, 0.3);
                border-color: rgba(255, 255, 255, 0.9);
            }

            50% {
                box-shadow: 0 0 18px rgba(230, 106, 69, 0.6), 0 0 35px rgba(255, 179, 138, 0.2);
                border-color: #fff;
            }
        }

        .sticker-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sticker-name {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-main);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: -12px;
            /* Pull behind avatar */
            padding-left: 16px;
            /* Space for avatar */
            z-index: 1;
            letter-spacing: 0.5px;
        }

        .sticker-reactions {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .reaction-emoji {
            font-size: 20px;
            line-height: 1;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.2));
        }

        .reaction-emoji:nth-child(2) {
            margin-left: -6px;
            /* Slight Overlap */
        }

        .reaction-count {
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            font-style: italic;
            margin-left: 4px;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
        }

        /* 3. THE CONNECTION (SVG LINE) */
        .connection-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
        }

        /* The specific geometry to connect bottom-right of card to top-left of pin */
        /* Card ends at: left 200px (40+160), top 300px (100+200) */
        /* Pin starts at: left 220px, top 350px */

        .tether-line {
            stroke: var(--gold-primary);
            stroke-width: 1;
            fill: none;
            /* Glowing effect */
            filter: drop-shadow(0 0 4px var(--gold-glow));
        }

        /* 4. THE DATA (BOTTOM RIGHT) */
        .stats-container {
            position: absolute;
            bottom: 120px;
            right: 24px;
            text-align: right;
            color: var(--text-main);
            pointer-events: none;
        }

        .stat-count {
            font-size: 14px;
            font-weight: 700;
            line-height: 1.4;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            display: block;
            margin-top: 8px;
            color: var(--gold-primary);
            font-family: var(--font-display);
            font-size: 18px;
            letter-spacing: 1px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            opacity: 0.7;
            margin-bottom: 0;
            display: block;
        }

        .city-context {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.8;
            color: var(--gold-primary);
            font-family: var(--font-ui);
            font-size: 10px;
            margin-bottom: 2px;
            display: block;
        }

        .beacon-title-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 6px;
        }

        .title-pin-icon {
            width: 18px;
            height: 18px;
            color: var(--gold-primary);
            filter: drop-shadow(0 0 4px var(--gold-glow));
        }

        .beacon-name {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            line-height: 0.9;
            margin: 0;
            text-shadow: 0 0 20px rgba(230, 106, 69, 0.4);
            color: #fff;
        }

        /* Animation */
        @keyframes pulse {
            0% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.1);
                filter: brightness(1.3);
            }

            100% {
                transform: scale(1);
                filter: brightness(1);
            }
        }

        /* --- TUNER (Drift Control) --- */
        .resonance-control {
            position: absolute;
            bottom: 60px;
            /* Specific placement */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            z-index: 100;
            pointer-events: auto;
        }

        .tuner-ring {
            width: 80px;
            height: 80px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .tuner-ticks {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: radar-spin 12s linear infinite;
            opacity: 0.6;
        }

        .tick-circle {
            fill: none;
            stroke: var(--gold-primary);
            stroke-width: 1.5;
            stroke-dasharray: 1 6;
            /* Dotted line like a dial */
            stroke-linecap: round;
        }

        .tuner-knob-core {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(145deg, rgba(30, 30, 30, 0.8), rgba(10, 10, 10, 0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 179, 138, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow:
                0 10px 30px rgba(0, 0, 0, 0.5),
                inset 0 0 20px rgba(255, 179, 138, 0.05);
            z-index: 2;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .signal-dot {
            width: 8px;
            height: 8px;
            background: var(--gold-primary);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--gold-glow);
            animation: signal-pulse 3s infinite;
        }

        /* Hover interactions */
        .resonance-control:hover .tuner-knob-core {
            border-color: var(--gold-primary);
            box-shadow: 0 0 25px rgba(230, 106, 69, 0.2);
            transform: scale(1.1);
        }

        .resonance-control:hover .tuner-ticks {
            opacity: 1;
            filter: drop-shadow(0 0 5px var(--gold-glow));
        }

        .resonance-control:active .tuner-knob-core {
            transform: scale(0.95);
        }

        @keyframes radar-spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @keyframes signal-pulse {
            0% {
                transform: scale(1);
                opacity: 0.6;
                box-shadow: 0 0 0 transparent;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
                box-shadow: 0 0 15px var(--gold-glow);
            }

            100% {
                transform: scale(1);
                opacity: 0.6;
                box-shadow: 0 0 0 transparent;
            }
        }

        .orb-label {
            font-family: var(--font-ui);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.7);
            text-shadow: 0 0 10px rgba(255, 200, 100, 0.3);
            transition: color 0.3s;
        }

        .resonance-control:hover .orb-label {
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 220, 150, 0.8);
        }

        /* Icon Animation - Removed as we use dots/ticks now */

        /* --- RESONANCE PROMPT (Radar) --- */
        .resonance-prompt {
            position: absolute;
            bottom: 110px;
            /* Above the Seek Button */
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(0, 0, 0, 0.4);
            padding: 6px 12px;
            border-radius: 20px;
            pointer-events: none;
            opacity: 0;
            /* Hidden by default */
            transition: opacity 0.5s ease;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .resonance-prompt.visible {
            opacity: 1;
        }

        /* --- UI FADE UTILITY --- */
        .ui-element {
            transition: opacity 0.4s ease, transform 0.4s ease;
            opacity: 1;
        }

        .ui-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            /* Subtle drop effect */
        }

        /* --- DEV NAVIGATION --- */
        .nav-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            pointer-events: auto;
            font-family: var(--font-main);
        }

        .nav-toggle {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            backdrop-filter: blur(8px);
            transition: all 0.2s;
        }

        .nav-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: var(--gold-primary);
        }

        .nav-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 4px;
            min-width: 160px;
            backdrop-filter: blur(16px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .nav-menu.visible {
            color: var(--gold-primary);
        }

        /* --- TOP HEADER & STATUS BAR --- */
        .header-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 0 24px;
            box-sizing: border-box;
            z-index: 90;
            pointer-events: none;
            display: flex;
            flex-direction: column;
        }

        .status-row {
            height: 54px;
            /* Align with Dynamic Island */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            padding-top: 12px;
        }

        .status-right {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .app-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: -10px;
            pointer-events: auto;
        }

        .user-id {
            font-family: var(--font-ui);
            font-weight: 800;
            font-size: 20px;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            text-transform: uppercase;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(20, 20, 20, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--gold-primary);
            color: var(--gold-primary);
            transform: translateY(-2px);
        }

        .icon-btn svg {
            width: 22px;
            height: 22px;
            stroke-width: 1.5px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            transition: all 0.2s;
            display: block;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gold-primary);
        }
    </style>
</head>

<body>

    <div class="phone-frame">
        <div class="dynamic-island"></div>

        <!-- Top Header & Status Bar -->
        <div class="header-layer">
            <!-- Status Bar (Aligned with Notch) -->
            <div class="status-row">
                <span class="time">10:04</span>
                <div class="status-right">
                    <!-- Signal -->
                    <svg width="18" height="12" viewBox="0 0 18 12" fill="currentColor">
                        <path d="M1 10H3V12H1V10ZM6 7H8V12H6V7ZM11 4H13V12H11V4ZM16 1H18V12H16V1Z" />
                    </svg>
                    <!-- Wifi -->
                    <svg width="20" height="14" viewBox="0 0 20 14" fill="currentColor">
                        <path
                            d="M10.0003 12.6366L0.90918 3.54546C1.49883 2.95507 2.19904 2.48679 2.96954 2.16752C3.74004 1.84825 4.56573 1.68426 5.39956 1.68494C6.23338 1.68561 7.05898 1.85093 7.82914 2.17145C8.59931 2.49197 9.29895 2.96141 9.88796 3.55299L10.0003 3.66531L10.1126 3.55299C11.3023 2.3644 12.9152 1.6968 14.597 1.6968C16.2789 1.6968 17.8918 2.3644 19.0814 3.55299L10.0003 12.6366ZM10.0003 10.0911L16.536 3.55544C16.0216 3.0409 15.3238 2.75185 14.5963 2.75185C13.8687 2.75185 13.1709 3.0409 12.6565 3.55544L10.0003 6.21166L7.34406 3.55544C6.82963 3.0409 6.13182 2.75185 5.40429 2.75185C4.67677 2.75185 3.97896 3.0409 3.46453 3.55544L10.0003 10.0911Z"
                            stroke="none" />
                        <path d="M10 12.6366L3.46448 6.10113L16.5355 6.10113L10 12.6366Z" fill="currentColor" />
                    </svg>
                    <!-- Battery -->
                    <svg width="24" height="12" viewBox="0 0 24 12" fill="none" class="battery-icon">
                        <rect x="1" y="1" width="20" height="10" rx="2.5" stroke="currentColor" stroke-width="1.5" />
                        <path d="M23 4V8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                        <rect x="3" y="3" width="16" height="6" rx="1.5" fill="currentColor" />
                    </svg>
                </div>
            </div>

            <!-- App Header (User & Actions) -->
            <div class="app-header-row">
                <div class="user-id">Kobe2025</div>
                <div class="header-actions">
                    <!-- Friends List -->
                    <div class="icon-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <!-- Messages -->
                    <div class="icon-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Background Map -->
        <div id="map"></div>
        <div class="vignette"></div>

        <!-- SVG Layer for the connecting line -->
        <svg class="connection-layer ui-element">
            <!-- 
               Drawing a line from Memory Card Bottom-Right to Pin Top-Left 
               Card Bottom Right: x=200, y=300
               Pin Top Left (approx): x=210, y=340
            -->
            <line x1="200" y1="300" x2="220" y2="340" class="tether-line" />

            <!-- Optional: A small dot at the anchor point on the image -->
            <circle cx="200" cy="300" r="2" fill="#ffb38a" />
        </svg>

        <!-- UI Elements -->
        <div class="ui-layer">

            <!-- The Memory (Image Section) -->
            <div class="memory-card ui-element">
                <!-- Using a moody atmospheric image -->
                <img src="image/manga.png" class="memory-image" alt="Memory">

                <!-- The Sticker (Now Above) -->
                <div class="memory-sticker">
                    <div class="sticker-avatar"
                        style="background-image: url('https://api.dicebear.com/7.x/notionists/svg?seed=Felix')"></div>
                    <div class="sticker-name">Felix</div>
                    <div class="sticker-reactions">
                        <div class="reaction-emoji">ðŸŽ©</div>
                        <div class="reaction-emoji">ðŸ¥¶</div>
                        <span class="reaction-count">x4</span>
                    </div>
                </div>
            </div>

            <!-- The Navigator (Center Bottom) -->
            <div class="resonance-prompt">âœ¨ High resonance detected nearby...</div>

            <!-- The Resonance Tuner (Drift Control) -->
            <div class="resonance-control" onclick="seekNextSignal()">
                <div class="tuner-ring">
                    <svg class="tuner-ticks" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="46" class="tick-circle" />
                    </svg>
                    <div class="tuner-knob-core">
                        <div class="signal-dot"></div>
                    </div>
                </div>
                <span class="orb-label">TUNE IN</span>
            </div>

            <!-- The Stats (Bottom Right - The "Dock") -->
            <div class="stats-container">
                <span class="city-context">SAN FRANCISCO</span>

                <div class="beacon-title-row">
                    <svg class="title-pin-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
                    </svg>
                    <h1 class="beacon-name">MISSION DISTRICT</h1>
                </div>

                <span class="stat-count">30,621 Memories</span>
                <span class="stat-label">from 421 people</span>
            </div>

        </div>
    </div>

    <!-- Dev Navigation -->
    <div class="nav-overlay">
        <button class="nav-toggle" onclick="toggleNav()">â˜° Pages</button>
        <div class="nav-menu" id="navMenu">
            <a href="main.html" class="nav-link">Main</a>
            <a href="main_time_variant.html" class="nav-link">Main (Time Variant)</a>
            <a href="main_bignumber_withHeads.html" class="nav-link">Main (Big Number)</a>
            <a href="map_view.html" class="nav-link">Map View (Clean)</a>
        </div>
    </div>

    <script>
        function toggleNav() {
            document.getElementById('navMenu').classList.toggle('visible');
        }
    </script>

    <script>
        // --- CONFIGURATION ---
        const sfCoords = [37.7749, -122.4194];
        const missionCoords = [37.7599, -122.4148]; // Mission District approx center

        // Initialize the map
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            zoomAnimation: true,
            fadeAnimation: true,
            markerZoomAnimation: true
        }).setView(sfCoords, 12);

        // Add the dark mode tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // --- 1. THE STARS ENGINE (Luminous Breath) ---
        function bakeGlowTexture(radius, color) {
            const size = radius * 2;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createRadialGradient(radius, radius, 0, radius, radius, radius);
            gradient.addColorStop(0, 'rgba(255, 240, 230, 0.9)');
            gradient.addColorStop(0.15, 'rgba(255, 179, 138, 0.6)');
            gradient.addColorStop(0.4, 'rgba(230, 106, 69, 0.15)');
            gradient.addColorStop(1, 'rgba(230, 106, 69, 0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, size, size);
            return canvas;
        }

        // Generate "Memories" Data - Organic Tendrils
        // --- GLOBAL MEMORY DATA ---
        const clusters = [
            { lat: missionCoords[0], lng: missionCoords[1], count: 180, spread: 0.008 },
            { lat: 37.7609, lng: -122.4350, count: 60, spread: 0.006 },
            { lat: 37.780, lng: -122.405, count: 60, spread: 0.006 }
        ];

        function generateOrganicMemories(clusters) {
            const points = [];
            clusters.forEach(cluster => {
                const coreCount = Math.floor(cluster.count * 0.4);
                for (let i = 0; i < coreCount; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const dist = Math.random() * cluster.spread * 0.3;
                    points.push({
                        lat: cluster.lat + Math.sin(angle) * dist * 0.6,
                        lng: cluster.lng + Math.cos(angle) * dist,
                        phase: Math.random() * Math.PI * 2,
                        speed: 0.2 + Math.random() * 0.5,
                        sizeVar: 0.8 + Math.random() * 0.5
                    });
                }
                const tendrilCount = 4 + Math.floor(Math.random() * 3);
                const pointsPerTendril = Math.floor((cluster.count - coreCount) / tendrilCount);
                for (let t = 0; t < tendrilCount; t++) {
                    let tLat = cluster.lat;
                    let tLng = cluster.lng;
                    const streetAngle = Math.random() * Math.PI * 2;
                    const stepSize = cluster.spread * 0.15;
                    for (let p = 0; p < pointsPerTendril; p++) {
                        tLat += Math.sin(streetAngle) * stepSize * (0.9 + Math.random() * 0.2);
                        tLng += Math.cos(streetAngle) * stepSize * (0.9 + Math.random() * 0.2);
                        const drift = stepSize * 0.4;
                        const pLat = tLat + (Math.random() - 0.5) * drift;
                        const pLng = tLng + (Math.random() - 0.5) * drift;
                        points.push({
                            lat: pLat,
                            lng: pLng,
                            phase: Math.random() * Math.PI * 2,
                            speed: 0.2 + Math.random() * 0.5,
                            sizeVar: 0.6 + Math.random() * 0.8
                        });
                    }
                }
            });
            return points;
        }

        const allMemories = generateOrganicMemories(clusters);

        // Custom Leaflet Layer
        L.StarFieldLayer = L.Layer.extend({
            onAdd: function (map) {
                this._map = map;
                this._canvas = L.DomUtil.create('canvas', 'star-field-layer');
                const size = map.getSize();
                this._canvas.width = size.x;
                this._canvas.height = size.y;

                // Add to overlay pane
                this.getPane().appendChild(this._canvas);

                this._glowSprite = bakeGlowTexture(48, '#ffb38a');

                this._points = allMemories;

                map.on('move', this._update, this);
                map.on('zoom', this._update, this);
                map.on('resize', this._resize, this);

                this._animating = true;
                this._animate();
            },

            onRemove: function (map) {
                map.getPane().appendChild(this._canvas).remove();
                map.off('move', this._update, this);
                map.off('zoom', this._update, this);
                map.off('resize', this._resize, this);
                this._animating = false;
            },

            _resize: function () {
                const size = this._map.getSize();
                this._canvas.width = size.x;
                this._canvas.height = size.y;
            },

            _update: function () {
                // We handle updates in the render loop for sync
            },

            _animate: function () {
                if (!this._animating) return;
                this._render();
                requestAnimationFrame(() => this._animate());
            },

            _render: function () {
                const map = this._map;
                const canvas = this._canvas;
                const ctx = canvas.getContext('2d');
                const zoom = map.getZoom();
                const now = Date.now() / 1000;

                // --- CRITICAL FIX FOR SYNC ---
                // Reset canvas position to match viewport top-left
                // map.containerPointToLayerPoint([0,0]) gives the Layer Coordinate of the screen's top-left.
                // We move the canvas there.
                const topLeft = map.containerPointToLayerPoint([0, 0]);
                L.DomUtil.setPosition(canvas, topLeft);

                // Clear using canvas width (viewport size)
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.globalCompositeOperation = 'screen';

                let baseRadius, globalAlphaMod;
                if (zoom < 13) {
                    baseRadius = 14; globalAlphaMod = 0.3;
                } else if (zoom < 15) {
                    const t = (zoom - 13) / 2;
                    baseRadius = 14 - (t * 8);
                    globalAlphaMod = 0.3 + (t * 0.3);
                } else {
                    baseRadius = 8; globalAlphaMod = 0.8;
                }

                this._points.forEach(p => {
                    // latLngToContainerPoint gives coordinates relative to Viewport Top-Left [0,0]
                    // Since we moved our canvas to Viewport Top-Left, these coords map 1:1 to Canvas coords!
                    const point = map.latLngToContainerPoint([p.lat, p.lng]);

                    // Render Culling
                    if (point.x < -100 || point.x > canvas.width + 100 || point.y < -100 || point.y > canvas.height + 100) return;

                    const breath = Math.sin(now * p.speed + p.phase);
                    const sizeMod = (1 + (breath * 0.2)) * p.sizeVar;
                    const opacityMod = 0.5 + (breath * 0.3);

                    const currentRadius = baseRadius * sizeMod;
                    const finalAlpha = globalAlphaMod * opacityMod;

                    ctx.globalAlpha = finalAlpha;
                    const size = currentRadius * 4;
                    ctx.drawImage(this._glowSprite, point.x - size / 2, point.y - size / 2, size, size);
                });
            }
        });

        new L.StarFieldLayer().addTo(map);

        // --- PIN & TETHER LOGIC ---
        const pinHtml = `
            <div class="map-pin">
                <div class="glow-point-main"></div>
                <img src="image/B1.png" class="pin-icon" alt="Beacon">
            </div>
        `;
        const customIcon = L.divIcon({
            className: 'custom-pin-container',
            html: pinHtml,
            iconSize: [80, 80],
            iconAnchor: [40, 40]
        });
        const marker = L.marker(missionCoords, { icon: customIcon }).addTo(map);

        // --- LIGHTHOUSE BEACONS SETUP ---
        // Mock data reordered for Counter-Clockwise flow around Mission (Center)
        // Order: SoMa (NE) -> Nob Hill (N) -> Castro (W) -> Bernal (S)
        const otherBeacons = [
            { lat: 37.780, lng: -122.405, id: 'soma' },      // Top Right
            { lat: 37.790, lng: -122.420, id: 'nobhill' },   // Top Left
            { lat: 37.7609, lng: -122.4350, id: 'castro' },  // Left
            { lat: 37.750, lng: -122.410, id: 'bernal' }     // Bottom
        ];

        const lighthouseMarkers = [];
        const buildingImages = ['image/B1.png', 'image/B2.png', 'image/B3.png'];

        otherBeacons.forEach(b => {
            // Random building
            const randomImg = buildingImages[Math.floor(Math.random() * buildingImages.length)];

            const html = `
                <div class="lighthouse-pin">
                    <div class="glow-point"></div>
                    <img src="${randomImg}" class="building-img" alt="Beacon">
                </div>
             `;

            const icon = L.divIcon({
                className: 'lighthouse-container',
                html: html,
                iconSize: [60, 60],
                iconAnchor: [30, 30]
            });
            const m = L.marker([b.lat, b.lng], { icon: icon }).addTo(map);
            lighthouseMarkers.push(m);
        });

        const lineElement = document.querySelector('.tether-line');
        const memoryCard = document.querySelector('.memory-card');

        function updateTether() {
            const cardAnchorX = 40 + 160;
            const cardAnchorY = 140 + 200; // Bottom-Right of Card

            // Get Pin Center
            const pinPoint = map.latLngToContainerPoint(marker.getLatLng());

            // Calculate Top-Left of Pin (assuming 80x80 pin, center anchored)
            // Center is (0,0) relative to anchor. Top-Left is -40,-40.
            // We'll target slightly inside the corner for visuals (-30)
            const pinTargetX = pinPoint.x - 30;
            const pinTargetY = pinPoint.y - 30;

            lineElement.setAttribute('x1', cardAnchorX);
            lineElement.setAttribute('y1', cardAnchorY);
            lineElement.setAttribute('x2', pinTargetX);
            lineElement.setAttribute('y2', pinTargetY);
        }

        // --- VISIBILITY & LIGHTHOUSE LOGIC ---
        const uiElements = document.querySelectorAll('.ui-element');
        const resonancePrompt = document.querySelector('.resonance-prompt');
        let lighthouseInterval = null;
        let lighthouseIndex = 0;

        function startLighthouse() {
            if (lighthouseInterval) return; // Already running

            // Immediately start
            cycleLighthouse();

            // Cycle every 2 seconds for a faster "scanning" feel
            lighthouseInterval = setInterval(cycleLighthouse, 2000);
        }

        function stopLighthouse() {
            if (!lighthouseInterval) return;
            clearInterval(lighthouseInterval);
            lighthouseInterval = null;

            // Clear all active states immediately
            lighthouseMarkers.forEach(m => {
                const el = m.getElement().querySelector('.lighthouse-pin');
                if (el) el.classList.remove('active');
            });
        }

        function cycleLighthouse() {
            // 1. HARD RESET: Turn off EVERYONE first
            lighthouseMarkers.forEach(m => {
                const el = m.getElement().querySelector('.lighthouse-pin');
                if (el) el.classList.remove('active');
            });

            // 2. Turn on ONLY the current target
            const target = lighthouseMarkers[lighthouseIndex];
            if (target) {
                const el = target.getElement().querySelector('.lighthouse-pin');
                if (el) el.classList.add('active');
            }

            // 3. Increment for next time (Loop)
            lighthouseIndex = (lighthouseIndex + 1) % lighthouseMarkers.length;
        }

        function updateVisibility() {
            const zoom = map.getZoom();

            // THRESHOLD: 15
            if (zoom < 15) {
                // --- OVERVIEW MODE ---
                document.body.classList.remove('detail-mode');
                uiElements.forEach(el => el.classList.add('ui-hidden'));
                startLighthouse();
            } else {
                // --- DETAIL MODE ---
                document.body.classList.add('detail-mode');
                uiElements.forEach(el => el.classList.remove('ui-hidden'));
                stopLighthouse();
            }

            updateTether();
        }

        // Simple resonance simulator
        function checkResonance() {
            // In a real app, this would check distance to nearest cluster
            // Here we just randomly pulse it when moving for "feeling"
            if (Math.random() > 0.95) {
                resonancePrompt.innerText = "âœ¨ Someone felt similar here...";
                resonancePrompt.classList.add('visible');
                setTimeout(() => resonancePrompt.classList.remove('visible'), 3000);
            }
        }

        map.on('move', () => {
            updateTether();
            checkResonance();
        });
        map.on('zoom', updateVisibility);
        map.on('viewreset', updateTether);
        updateVisibility(); // Ensure initial state is correct regarding zoom level

        setTimeout(() => {
            map.flyTo(missionCoords, 16, { animate: true, duration: 3 });
        }, 1000);

        // --- MEMORY STREAMS (CHANNELS) ---
        const memoryStreams = [
            {
                id: 0,
                image: 'image/manga.png',
                building: 'image/B1.png',
                coords: missionCoords, // Mission District
                user: {
                    name: 'Felix',
                    avatar: 'https://api.dicebear.com/7.x/notionists/svg?seed=Felix',
                    reactions: ['ðŸŽ©', 'ðŸ¥¶'],
                    count: 'x4',
                    beaconName: 'MISSION DISTRICT'
                }
            },
            {
                id: 1,
                image: 'image/manga2.gif',
                building: 'image/B2.png',
                coords: [37.7609, -122.4350], // Castro Style Location
                user: {
                    name: 'Aria',
                    avatar: 'https://api.dicebear.com/7.x/notionists/svg?seed=Aria',
                    reactions: ['âš¡', 'âœ¨'],
                    count: 'x12',
                    beaconName: 'CASTRO TOWER'
                }
            },
            {
                id: 2,
                image: 'image/manga3.png',
                building: 'image/B3.png',
                coords: [37.780, -122.405], // SoMa Style Location
                user: {
                    name: 'Zen',
                    avatar: 'https://api.dicebear.com/7.x/notionists/svg?seed=Zen',
                    reactions: ['ðŸŒŠ', 'ðŸŽ¹'],
                    count: 'x8',
                    beaconName: 'SOMA HUB'
                }
            }
        ];

        let currentMemoryIndex = 0; // Starts at 0 (Felix/B1)

        // --- SEEK NEXT SIGNAL LOGIC ---
        function seekNextSignal() {
            // 1. Calculate next index
            currentMemoryIndex = (currentMemoryIndex + 1) % memoryStreams.length;
            const data = memoryStreams[currentMemoryIndex];

            // 2. UI Feedback (Knob spin)
            const knob = document.querySelector('.tuner-knob-core');
            const label = document.querySelector('.orb-label');

            if (knob) knob.style.transform = 'scale(0.9) rotate(90deg)';
            if (label) label.innerText = "TUNING...";

            // 3. Start Transition (Fade Out)
            const memoryCard = document.querySelector('.memory-card');
            const pinIcon = document.querySelector('.map-pin .pin-icon');
            const beaconName = document.querySelector('.beacon-name');
            const stickerName = document.querySelector('.sticker-name');
            const stickerAvatar = document.querySelector('.sticker-avatar');
            const stickerReactions = document.querySelector('.sticker-reactions');

            // Add a transition class to blur/fade
            memoryCard.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            memoryCard.style.opacity = '0';
            memoryCard.style.transform = 'translateY(10px) scale(0.95)';

            // 4. Update Marker Position & Fly
            marker.setLatLng(data.coords); // <--- IMPORTANT: Move pin to new location
            map.flyTo(data.coords, 16, {
                animate: true,
                duration: 1.5,
                easeLinearity: 0.2
            });

            // 5. Update Content & Fade In after short delay
            setTimeout(() => {
                // Update Memory Image
                document.querySelector('.memory-image').src = data.image;

                // Update User Info
                if (stickerAvatar) stickerAvatar.style.backgroundImage = `url('${data.user.avatar}')`;
                if (stickerName) stickerName.innerText = data.user.name;

                // Update Reactions
                if (stickerReactions) {
                    stickerReactions.innerHTML = `
                        <div class="reaction-emoji">${data.user.reactions[0]}</div>
                        <div class="reaction-emoji">${data.user.reactions[1]}</div>
                        <span class="reaction-count">${data.user.count}</span>
                    `;
                }

                // Update Building Pin in the map
                if (pinIcon) {
                    pinIcon.src = data.building;
                    // Reset animation to make it pop
                    pinIcon.style.animation = 'none';
                    pinIcon.offsetHeight; /* trigger reflow */
                    pinIcon.style.animation = 'pulse 3s infinite ease-in-out';
                }

                // Update Beacon Title
                if (beaconName) beaconName.innerText = data.user.beaconName;

                // Reset Knob
                if (knob) knob.style.transform = '';

                // Fade In
                memoryCard.style.opacity = '1';
                memoryCard.style.transform = 'translateY(0px) scale(1)';

                // Reset Label
                if (label) label.innerText = "TUNE IN";

            }, 500);
        }
    </script>
</body>

</html>